<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đánh giá rủi ro ATVSLĐ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        td {
            vertical-align: top;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Đánh giá rủi ro ATVSLĐ</h1>
            <p class="mt-2 text-gray-600">Sử dụng AI để phân tích và đưa ra các biện pháp phòng ngừa</p>
            <p class="text-sm text-gray-500 mt-1">Version 0.5 - Cải tiến</p>
        </header>

        <main>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <!-- NEW: User information fields -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="full-name" class="block text-sm font-medium text-gray-700">Họ và Tên người thực hiện</label>
                        <input type="text" id="full-name" class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nhập tên của bạn">
                    </div>
                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-700">Vị trí</label>
                        <input type="text" id="location" class="mt-1 w-full p-2 border border-gray-300 rounded-md bg-gray-100" placeholder="Đang tìm vị trí..." readonly>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="job-description" class="block text-lg font-medium text-gray-700 mb-2">Mô tả công việc hoặc hiện trường</label>
                    <textarea id="job-description" rows="6" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Ví dụ: Thi công hàn cắt trên giàn giáo cao 10m, khu vực có gió và nhiều người qua lại bên dưới..."></textarea>
                </div>
                <button id="analyze-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out flex items-center justify-center">
                    <svg id="analyze-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.938V19h2v-4.062a8.001 8.001 0 00-4 0z" clip-rule="evenodd" />
                        <path d="M10 2a5 5 0 00-5 5v4a5 5 0 0010 0V7a5 5 0 00-5-5zM5 7a3 3 0 013-3h4a3 3 0 013 3v4a3 3 0 01-3 3H8a3 3 0 01-3-3V7z" />
                    </svg>
                    Phân tích rủi ro
                </button>
            </div>

            <div id="loading" class="text-center my-8 hidden">
                <div class="loader inline-block"></div>
                <p class="mt-2 text-gray-600">AI đang phân tích, vui lòng chờ trong giây lát...</p>
            </div>
            
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative my-6" role="alert">
                <strong class="font-bold">Lỗi!</strong>
                <span class="block sm:inline" id="error-text"></span>
            </div>

            <div id="results" class="mt-8 bg-white p-6 rounded-lg shadow-md hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Kết quả phân tích</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Tên rủi ro</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Mức độ rủi ro</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Biện pháp kiểm soát</th>
                                <th scope="col" class="relative px-6 py-3">
                                    <span class="sr-only">Hiệu chỉnh</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="risk-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Dữ liệu sẽ được chèn vào đây bởi JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div id="summary" class="mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-xl font-bold text-gray-900">Tổng hợp & Khuyến nghị</h3>
                    <div id="conclusion" class="mt-4 text-lg font-semibold p-4 rounded-md"></div>
                </div>
                <!-- Copy button -->
                <div class="mt-8 pt-6 border-t border-gray-200 text-center">
                    <button id="copy-report-btn" class="bg-gray-600 text-white font-bold py-3 px-6 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-300 ease-in-out">
                        Sao chép Nội dung
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Hiệu chỉnh -->
    <div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-3xl flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold">Hiệu chỉnh đánh giá rủi ro</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto" style="max-height: 70vh;">
                <input type="hidden" id="edit-risk-index">
                <div class="mb-4">
                    <label for="edit-risk-name" class="block text-sm font-medium text-gray-700">Tên rủi ro</label>
                    <input type="text" id="edit-risk-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-100" readonly>
                </div>
        
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="edit-severity" class="block text-sm font-medium text-gray-700">Sự nghiêm trọng (S)</label>
                        <select id="edit-severity" class="risk-param mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="1">Không đáng kể (Không gây thương tích)</option>
                            <option value="2">Nhẹ (Thương tích nhẹ, cần sơ cứu)</option>
                            <option value="3">Trung bình (Thương tích cần điều trị y tế)</option>
                            <option value="4">Cao (Thương tích nghiêm trọng, mất khả năng làm việc)</option>
                            <option value="5">Thảm khốc (Thương tật vĩnh viễn hoặc tử vong)</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-likelihood" class="block text-sm font-medium text-gray-700">Khả năng xảy ra (L)</label>
                        <select id="edit-likelihood" class="risk-param mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="1">Rất hiếm khi (Có thể xảy ra, nhưng rất khó)</option>
                            <option value="2">Hiếm khi (Khó xảy ra)</option>
                            <option value="3">Có thể (Có thể xảy ra)</option>
                            <option value="4">Thường xuyên (Có khả năng xảy ra cao)</option>
                            <option value="5">Rất thường xuyên (Chắc chắn sẽ xảy ra)</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-avoidance" class="block text-sm font-medium text-gray-700">Khả năng tránh được (A)</label>
                        <select id="edit-avoidance" class="risk-param mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="1">Rất dễ dàng (Luôn có thể tránh)</option>
                            <option value="2">Dễ dàng (Có thể tránh)</option>
                            <option value="3">Có thể (Có thể tránh được một phần)</option>
                            <option value="4">Khó khăn (Khó tránh)</option>
                            <option value="5">Không thể (Không thể tránh)</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="edit-control-measures" class="block text-sm font-medium text-gray-700">Biện pháp kiểm soát</label>
                    <textarea id="edit-control-measures" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ví dụ: Lắp đặt hệ thống lưới an toàn, trang bị dây an toàn cho người lao động..."></textarea>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3">
                <button id="cancel-edit-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-md hover:bg-gray-300">Hủy</button>
                <button id="save-edit-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Lưu thay đổi</button>
            </div>
        </div>
    </div>

    <!-- Notification message -->
    <div id="notification" class="fixed bottom-4 right-4 p-4 rounded-md shadow-lg hidden">
        <div class="flex items-center">
            <svg class="h-6 w-6 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            <p id="notification-text" class="ml-3 text-sm font-medium text-gray-700"></p>
        </div>
    </div>

    <script>
        const analyzeBtn = document.getElementById('analyze-btn');
        const jobDescription = document.getElementById('job-description');
        const loadingDiv = document.getElementById('loading');
        const resultsDiv = document.getElementById('results');
        const riskTableBody = document.getElementById('risk-table-body');
        const conclusionDiv = document.getElementById('conclusion');
        const errorMessageDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const copyReportBtn = document.getElementById('copy-report-btn');

        // Modal elements
        const editModal = document.getElementById('edit-modal');
        const editRiskIndex = document.getElementById('edit-risk-index');
        const editRiskName = document.getElementById('edit-risk-name');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        
        // New fields
        const fullNameInput = document.getElementById('full-name');
        const locationInput = document.getElementById('location');

        // New detailed modal elements
        const editSeverity = document.getElementById('edit-severity');
        const editLikelihood = document.getElementById('edit-likelihood');
        const editAvoidance = document.getElementById('edit-avoidance'); 
        const editControlMeasures = document.getElementById('edit-control-measures');
        
        // Notification elements
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');

        // Global array to store risk data
        let risksData = [];
        let conclusionText = '';
        
        // Event listeners
        analyzeBtn.addEventListener('click', handleAnalysis);
        copyReportBtn.addEventListener('click', copyReportToClipboard);
        closeModalBtn.addEventListener('click', closeModal);
        cancelEditBtn.addEventListener('click', closeModal);
        saveEditBtn.addEventListener('click', saveEdit);

        // API Configuration
        const API_KEY = "AIzaSyAM5rgSPq0S82FAxTM78T0aOj7xqzvHOLQ"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 5;
        const INITIAL_BACKOFF_DELAY = 1000;

        // Get user's GPS location on page load
        window.addEventListener('load', () => {
            if (navigator.geolocation) {
                locationInput.value = "Đang tìm vị trí...";
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude, longitude } = position.coords;
                        locationInput.value = `Vĩ độ: ${latitude.toFixed(4)}, Kinh độ: ${longitude.toFixed(4)}`;
                    },
                    error => {
                        console.error("Lỗi khi lấy vị trí: ", error);
                        locationInput.value = "Không thể lấy vị trí";
                    }
                );
            } else {
                locationInput.value = "Trình duyệt không hỗ trợ GPS.";
            }
        });

        /**
         * Handle the risk analysis process.
         */
        async function handleAnalysis() {
            const description = jobDescription.value.trim();
            if (!description) {
                showError("Vui lòng nhập mô tả công việc trước khi phân tích.");
                return;
            }

            setLoading(true);
            hideError();
            resultsDiv.classList.add('hidden');

            try {
                // Prompt the AI to provide detailed risk analysis including severity, likelihood, and control measures
                const prompt = `Bạn là một chuyên gia về An toàn, Vệ sinh Lao động (ATVSLĐ). Phân tích mô tả công việc sau đây và xác định các rủi ro tiềm ẩn. Cung cấp kết quả dưới dạng JSON.
                
                Mô tả công việc: "${description}"
                
                Cho mỗi rủi ro, hãy xác định các thông tin sau:
                - Tên rủi ro (name): Mô tả ngắn gọn về rủi ro.
                - Mức độ nghiêm trọng (severity): Một số từ 1-5 (1: Không đáng kể, 2: Nhẹ, 3: Trung bình, 4: Cao, 5: Thảm khốc).
                - Khả năng xảy ra (likelihood): Một số từ 1-5 (1: Rất hiếm, 2: Hiếm, 3: Có thể, 4: Thường xuyên, 5: Rất thường xuyên).
                - Khả năng tránh được (avoidance): Một số từ 1-5 (1: Rất dễ dàng, 2: Dễ dàng, 3: Có thể, 4: Khó khăn, 5: Không thể).
                - Biện pháp kiểm soát đề xuất (controlMeasures): Một danh sách các biện pháp ngắn gọn để kiểm soát rủi ro đó.
                
                Dựa trên ba tham số (Nghiêm trọng x Khả năng xảy ra x Khả năng tránh được), hãy xác định mức độ tổng thể của mỗi rủi ro và đưa ra kết luận cuối cùng cho toàn bộ công việc.
                - Nếu có bất kỳ rủi ro nào có mức độ 'Cao' hoặc 'Rất cao', kết luận phải là 'Ngừng làm việc'. Ngược lại, nếu tất cả rủi ro ở mức 'Thấp' hoặc 'Trung bình', kết luận là 'Cho phép làm việc'.`;

                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                risks: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            name: { type: "STRING" },
                                            severity: { type: "NUMBER" },
                                            likelihood: { type: "NUMBER" },
                                            avoidance: { type: "NUMBER" }, 
                                            controlMeasures: {
                                                type: "ARRAY",
                                                items: { type: "STRING" }
                                            }
                                        },
                                        required: ["name", "severity", "likelihood", "avoidance", "controlMeasures"]
                                    }
                                },
                                conclusion: { type: "STRING" }
                            },
                            required: ["risks", "conclusion"]
                        }
                    }
                };

                const data = await callGeminiAPI(payload);
                
                // Process the API response
                if (data && data.risks && data.conclusion) {
                    risksData = data.risks.map(risk => {
                        // Calculate overall risk level from the three parameters
                        const level = calculateOverallRisk(risk.severity, risk.likelihood, risk.avoidance);
                        return { ...risk, level };
                    });
                    conclusionText = data.conclusion;
                    displayResults();
                } else {
                    throw new Error("Phản hồi từ AI không hợp lệ hoặc không chứa nội dung.");
                }
            } catch (error) {
                console.error("Error during analysis:", error);
                showError("Đã xảy ra lỗi khi phân tích. Vui lòng thử lại. Chi tiết: " + error.message);
            } finally {
                setLoading(false);
            }
        }

        /**
         * Generic function to call Gemini API with retry mechanism.
         * @param {Object} payload The API payload.
         * @param {number} retries The number of retries.
         */
        async function callGeminiAPI(payload, retries = 0) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const jsonText = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonText);
            } catch (error) {
                if (retries < MAX_RETRIES) {
                    const delay = INITIAL_BACKOFF_DELAY * Math.pow(2, retries);
                    await new Promise(res => setTimeout(res, delay));
                    return callGeminiAPI(payload, retries + 1);
                } else {
                    throw error;
                }
            }
        }

        /**
         * Renders the results on the UI.
         */
        function displayResults() {
            riskTableBody.innerHTML = '';
            
            risksData.forEach((risk, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${risk.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${getRiskLevelBadge(risk.level)}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">
                        <ul class="list-disc list-inside space-y-1">
                            ${risk.controlMeasures.map(measure => `<li>${measure}</li>`).join('')}
                        </ul>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-index="${index}" class="edit-btn text-blue-600 hover:text-blue-900">Hiệu chỉnh</button>
                    </td>
                `;
                riskTableBody.appendChild(row);
            });

            // Add event listeners for each edit button
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = e.target.dataset.index;
                    openEditModal(index);
                });
            });

            updateConclusion();
            resultsDiv.classList.remove('hidden');
        }
        
        /**
         * Recalculates the conclusion based on the current risks.
         */
        function recalculateConclusionAndDisplay() {
            let hasHighRisk = false;
            for (const risk of risksData) {
                const level = risk.level.toLowerCase();
                if (level === 'cao' || level === 'rất cao') {
                    hasHighRisk = true;
                    break;
                }
            }

            conclusionText = hasHighRisk ? 'Ngừng làm việc' : 'Cho phép làm việc';
            updateConclusion();
        }

        /**
         * Updates the conclusion text and color on the UI.
         */
        function updateConclusion() {
            conclusionDiv.textContent = conclusionText;
            if (conclusionText.toLowerCase().includes('ngừng')) {
                conclusionDiv.className = 'mt-4 text-lg font-semibold p-4 rounded-md bg-red-100 text-red-800';
            } else {
                conclusionDiv.className = 'mt-4 text-lg font-semibold p-4 rounded-md bg-green-100 text-green-800';
            }
        }

        /**
         * Returns a colored badge for a given risk level.
         * @param {string} level The risk level (e.g., 'Thấp', 'Cao').
         */
        function getRiskLevelBadge(level) {
            let colorClasses = 'bg-gray-100 text-gray-800';
            switch (level.toLowerCase()) {
                case 'thấp':
                    colorClasses = 'bg-green-100 text-green-800';
                    break;
                case 'trung bình':
                    colorClasses = 'bg-yellow-100 text-yellow-800';
                    break;
                case 'cao':
                    colorClasses = 'bg-orange-100 text-orange-800';
                    break;
                case 'rất cao':
                    colorClasses = 'bg-red-100 text-red-800';
                    break;
            }
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${colorClasses}">${level}</span>`;
        }

        /**
         * Sets the loading state of the application.
         * @param {boolean} isLoading True to show loader, false to hide.
         */
        function setLoading(isLoading) {
            if (isLoading) {
                loadingDiv.classList.remove('hidden');
                analyzeBtn.disabled = true;
                analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                loadingDiv.classList.add('hidden');
                analyzeBtn.disabled = false;
                analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        /**
         * Displays an error message.
         * @param {string} message The error message to display.
         */
        function showError(message) {
            errorText.textContent = message;
            errorMessageDiv.classList.remove('hidden');
        }

        /**
         * Hides the error message.
         */
        function hideError() {
            errorMessageDiv.classList.add('hidden');
        }

        /**
         * Calculates the overall risk level based on severity, likelihood, and avoidance.
         * @param {number} severity The severity value (1-5).
         * @param {number} likelihood The likelihood value (1-5).
         * @param {number} avoidance The avoidance value (1-5).
         * @returns {string} The risk level ('Thấp', 'Trung bình', 'Cao', 'Rất cao').
         */
        function calculateOverallRisk(severity, likelihood, avoidance) {
            const score = severity * likelihood * avoidance;
            if (score <= 10) return 'Thấp';
            if (score <= 30) return 'Trung bình';
            if (score <= 60) return 'Cao';
            return 'Rất cao';
        }

        /**
         * Opens the edit modal and populates it with data.
         * @param {number} index The index of the risk to edit.
         */
        function openEditModal(index) {
            const risk = risksData[index];
            if (!risk) return;

            editRiskIndex.value = index;
            editRiskName.value = risk.name;
            editSeverity.value = risk.severity;
            editLikelihood.value = risk.likelihood;
            editAvoidance.value = risk.avoidance; 
            editControlMeasures.value = risk.controlMeasures.join('\n');
            
            editModal.classList.remove('hidden');
        }

        /**
         * Closes the edit modal.
         */
        function closeModal() {
            editModal.classList.add('hidden');
        }

        /**
         * Saves the edits from the modal to the data model and re-renders the UI.
         */
        function saveEdit() {
            const index = editRiskIndex.value;
            if (index === null) return;

            // Get new values from inputs
            const newSeverity = parseInt(editSeverity.value);
            const newLikelihood = parseInt(editLikelihood.value);
            const newAvoidance = parseInt(editAvoidance.value); 
            const newControlMeasures = editControlMeasures.value.split('\n').filter(cm => cm.trim() !== '');
            const newLevel = calculateOverallRisk(newSeverity, newLikelihood, newAvoidance);

            // Update the global data model with the three requested parameters
            risksData[index].severity = newSeverity;
            risksData[index].likelihood = newLikelihood;
            risksData[index].avoidance = newAvoidance; 
            risksData[index].level = newLevel;
            risksData[index].controlMeasures = newControlMeasures;

            // Re-render the UI based on the updated model
            displayResults();
            closeModal();
            recalculateConclusionAndDisplay();
        }

        /**
         * Copies the report content to the clipboard.
         */
        async function copyReportToClipboard() {
            const fullName = fullNameInput.value.trim();
            const location = locationInput.value.trim();
            const jobDesc = jobDescription.value.trim();
            
            if (!jobDesc) {
                showError("Không có nội dung để sao chép. Vui lòng phân tích công việc trước.");
                return;
            }

            let reportContent = "Báo cáo Đánh giá Rủi ro ATVSLĐ\n\n";
            reportContent += `Người thực hiện: ${fullName || 'Không xác định'}\n`;
            reportContent += `Vị trí: ${location || 'Không xác định'}\n\n`;
            reportContent += `Mô tả công việc: ${jobDesc}\n\n`;
            reportContent += `Kết luận: ${conclusionText}\n\n`;
            
            if (risksData.length > 0) {
                reportContent += "Chi tiết các rủi ro:\n";
                risksData.forEach(risk => {
                    reportContent += `- ${risk.name} (${risk.level})\n`;
                    if (risk.controlMeasures.length > 0) {
                        reportContent += "  Biện pháp kiểm soát:\n";
                        risk.controlMeasures.forEach(measure => reportContent += `  - ${measure}\n`);
                    }
                    reportContent += "\n";
                });
            }

            try {
                await navigator.clipboard.writeText(reportContent);
                showNotification("Đã sao chép báo cáo vào bộ nhớ tạm!");
            } catch (err) {
                console.error('Không thể sao chép văn bản: ', err);
                showError("Không thể sao chép báo cáo. Vui lòng thử lại.");
            }
        }
        
        /**
         * Shows a temporary notification.
         * @param {string} message The message to display.
         */
        function showNotification(message) {
            notificationText.textContent = message;
            notification.classList.remove('hidden');
            notification.classList.add('bg-green-100', 'text-green-800');
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

    </script>
</body>
</html>
